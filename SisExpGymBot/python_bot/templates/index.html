<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GymBot AI - Sistema Experto</title>
    
    <!-- Bootstrap 5.3 & Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <!-- Google Fonts: Poppins -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary-color: #4f46e5;
            --primary-hover: #4338ca;
            --accent-color: #818cf8;
            --bg-gradient: linear-gradient(135deg, #fdfbfb 0%, #ebedee 100%);
            --card-shadow: 0 10px 30px -5px rgba(0, 0, 0, 0.05);
            --halo-color: rgba(79, 70, 229, 0.25);
            --success-color: #10b981;
            --warning-color: #f59e0b;
        }

        body {
            background: var(--bg-gradient);
            font-family: 'Poppins', sans-serif;
            color: #1f2937;
            min-height: 100vh;
            padding-bottom: 40px;
        }

        .main-container {
            max-width: 1200px;
            margin: 40px auto;
        }

        /* Header Styles */
        .header {
            text-align: center;
            margin-bottom: 40px;
            position: relative;
        }
        
        .header h2 {
            font-weight: 700;
            color: #111827;
            letter-spacing: -0.5px;
            font-size: 2.5rem;
        }

        .header .badge-ai {
            background: var(--primary-color);
            color: white;
            font-size: 0.7rem;
            padding: 4px 8px;
            border-radius: 6px;
            vertical-align: middle;
            margin-left: 8px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .header-actions {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 15px;
        }

        /* Card Styles */
        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            box-shadow: var(--card-shadow);
            padding: 30px;
            transition: transform 0.2s ease;
        }

        .glass-card:hover {
            transform: translateY(-2px);
        }

        /* Form Controls & THE HALO EFFECT */
        .form-label {
            font-weight: 500;
            color: #374151;
            font-size: 0.9rem;
            margin-bottom: 8px;
        }

        .form-select, .form-control {
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 12px 15px;
            font-size: 0.95rem;
            color: #1f2937;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            background-color: #f9fafb;
        }

        .form-select:hover, .form-control:hover {
            border-color: #c7d2fe;
            background-color: #fff;
        }

        .form-select:focus, .form-control:focus {
            border-color: var(--primary-color);
            background-color: #fff;
            box-shadow: 0 0 0 4px var(--halo-color);
            outline: none;
        }

        /* Buttons */
        .btn-primary-custom {
            background: var(--primary-color);
            border: none;
            padding: 14px 28px;
            border-radius: 12px;
            font-weight: 600;
            width: 100%;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);
            color: white;
        }

        .btn-primary-custom:hover {
            background: var(--primary-hover);
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(79, 70, 229, 0.4);
            color: white;
        }

        .btn-outline-custom {
            border: 2px solid var(--primary-color);
            color: var(--primary-color);
            background: transparent;
            padding: 8px 16px;
            border-radius: 10px;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .btn-outline-custom:hover {
            background: var(--primary-color);
            color: white;
        }

        /* Results Section */
        .summary-card {
            background: #fff;
            border-left: 5px solid var(--primary-color);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 25px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .stat-box {
            background: #f9fafb;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            border: 1px solid #e5e7eb;
        }

        .stat-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--primary-color);
        }

        .stat-label {
            font-size: 0.85rem;
            color: #6b7280;
            margin-top: 5px;
        }

        .rutina-dia {
            background: white;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid #f3f4f6;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
            transition: transform 0.2s;
        }

        .rutina-dia:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        .dia-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            border-bottom: 2px solid #f3f4f6;
            padding-bottom: 10px;
        }

        .dia-badge {
            background: #e0e7ff;
            color: var(--primary-color);
            font-weight: 700;
            padding: 5px 12px;
            border-radius: 8px;
            margin-right: 10px;
        }

        .exercise-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .exercise-item {
            display: flex;
            align-items: flex-start;
            padding: 10px 0;
            border-bottom: 1px dashed #e5e7eb;
            transition: background 0.2s ease;
        }
        
        .exercise-item:hover {
            background: #f9fafb;
            border-radius: 8px;
            padding-left: 10px;
        }

        .exercise-item:last-child {
            border-bottom: none;
        }

        .exercise-icon {
            color: var(--accent-color);
            margin-right: 10px;
            margin-top: 3px;
        }

        .exercise-info-btn {
            margin-left: auto;
            background: transparent;
            border: none;
            color: var(--primary-color);
            cursor: pointer;
            padding: 5px;
            border-radius: 5px;
            transition: background 0.2s ease;
        }

        .exercise-info-btn:hover {
            background: #e0e7ff;
        }

        /* Animaci√≥n de entrada */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .animate-up {
            animation: fadeIn 0.5s ease-out forwards;
        }

        .param-tag {
            display: inline-block;
            background: #f3f4f6;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.85rem;
            margin-right: 5px;
            margin-bottom: 5px;
            color: #4b5563;
        }

        /* Recomendaciones */
        .recommendation-item {
            display: flex;
            align-items: start;
            padding: 10px;
            background: #fffbeb;
            border-left: 3px solid var(--warning-color);
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .recommendation-item i {
            color: var(--warning-color);
            margin-right: 10px;
            margin-top: 2px;
        }

        /* Timer de descanso */
        .rest-timer {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            display: none;
            z-index: 1000;
            min-width: 200px;
        }

        .rest-timer.active {
            display: block;
            animation: slideUp 0.3s ease-out;
        }

        @keyframes slideUp {
            from { transform: translateY(100px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .timer-display {
            font-size: 3rem;
            font-weight: 700;
            color: var(--primary-color);
            text-align: center;
            margin: 10px 0;
        }

        .timer-controls {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        /* Modal ejercicio */
        .modal-content {
            border-radius: 15px;
            border: none;
        }

        .modal-header {
            background: var(--primary-color);
            color: white;
            border-radius: 15px 15px 0 0;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header h2 {
                font-size: 2rem;
            }
            
            .stats-grid {
                grid-template-columns: 1fr 1fr;
            }

            .rest-timer {
                right: 15px;
                bottom: 15px;
                min-width: 150px;
            }

            .timer-display {
                font-size: 2rem;
            }
        }
        /* ===== MODO OSCURO ===== */
        body.dark-mode {
            --bg-gradient: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            background: var(--bg-gradient);
            color: #e4e4e7;
        }

        body.dark-mode .glass-card {
            background: rgba(30, 30, 46, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        body.dark-mode .form-select,
        body.dark-mode .form-control {
            background-color: #2d2d44;
            color: #e4e4e7;
            border-color: #3d3d5c;
        }

        body.dark-mode .form-select:hover,
        body.dark-mode .form-control:hover {
            background-color: #363654;
        }

        body.dark-mode .header h2 {
            color: #e4e4e7;
        }

        body.dark-mode .text-muted {
            color: #a1a1aa !important;
        }

        body.dark-mode .rutina-dia {
            background: #2d2d44;
            border-color: #3d3d5c;
        }

        body.dark-mode .summary-card {
            background: #2d2d44;
            border-left-color: var(--primary-color);
        }

        body.dark-mode .stat-box {
            background: #363654;
            border-color: #3d3d5c;
        }

        body.dark-mode .recommendation-item {
            background: #3d3d2e;
            border-left-color: var(--warning-color);
        }

        body.dark-mode .modal-content {
            background: #2d2d44;
            color: #e4e4e7;
        }

        body.dark-mode .modal-body {
            color: #e4e4e7;
        }

        body.dark-mode .btn-secondary {
            background: #3d3d5c;
            border-color: #3d3d5c;
        }

        /* Toggle Dark Mode Button */
        .dark-mode-toggle {
            position: fixed;
            bottom: 30px;
            left: 30px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--primary-color);
            border: none;
            color: white;
            font-size: 1.3rem;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .dark-mode-toggle:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.4);
        }

        @media (max-width: 768px) {
            .dark-mode-toggle {
                bottom: 80px;
                left: 15px;
                width: 45px;
                height: 45px;
                font-size: 1.1rem;
            }
        }

        .btn-outline-primary {
            border: 1px solid var(--primary-color);
            color: var(--primary-color);
            background: transparent;
            transition: all 0.2s ease;
        }

        .btn-outline-primary:hover {
            background: var(--primary-color);
            color: white;
        }

        body.dark-mode .btn-outline-primary {
            border-color: var(--accent-color);
            color: var(--accent-color);
        }

        body.dark-mode .btn-outline-primary:hover {
            background: var(--accent-color);
            color: #1f2937;
        }
    </style>
</head>

<body>

<div class="container main-container">

    <!-- Header -->
    <div class="header">
        <h2>üèãÔ∏è GymBot <span class="badge-ai">AI EXPERT</span></h2>
        <p class="text-muted">Sistema Experto de Entrenamiento Personalizado con IA</p>
        <div class="header-actions">
            <a href="/historial" class="btn btn-sm btn-outline-custom">
                <i class="bi bi-clock-history me-1"></i> Historial
            </a>
            <button type="button" class="btn btn-sm btn-outline-custom" onclick="abrirCalculadora1RM()">
                <i class="bi bi-calculator me-1"></i> Calculadora 1RM
            </button>
            {% if session.get('historial') and session.get('historial')|length >= 2 %}
            <button type="button" class="btn btn-sm btn-outline-custom" onclick="abrirComparador()">
                <i class="bi bi-arrow-left-right me-1"></i> Comparar Rutinas
            </button>
            {% endif %}
        </div>
    </div>

    <!-- Alertas -->
    {% if error and (objetivo or nivel or dias > 0) %}
        <div class="alert alert-danger d-flex align-items-center rounded-3 shadow-sm animate-up" role="alert">
            <i class="bi bi-exclamation-triangle-fill me-2"></i>
            <div>{{ error }}</div>
        </div>
    {% endif %}

    <!-- Formulario Principal -->
    <form method="POST" class="glass-card mb-5 animate-up">
        <h4 class="mb-4 fw-bold"><i class="bi bi-sliders me-2 text-primary"></i>Configuraci√≥n de Entrenamiento</h4>

        <div class="row g-4">
            <!-- Objetivo -->
            <div class="col-md-6">
                <label class="form-label">Objetivo Principal</label>
                <div class="input-group">
                    <span class="input-group-text bg-white border-end-0 rounded-start-3"><i class="bi bi-bullseye text-primary"></i></span>
                    <select name="objetivo" class="form-select border-start-0 ps-0" required>
                        <option value="" selected disabled>Seleccionar...</option>
                        <option value="ganar_masa" {% if objetivo == 'ganar_masa' %}selected{% endif %}>Ganar Masa Muscular</option>
                        <option value="bajar_grasa" {% if objetivo == 'bajar_grasa' %}selected{% endif %}>Bajar Grasa / Definir</option>
                        <option value="fuerza" {% if objetivo == 'fuerza' %}selected{% endif %}>Ganar Fuerza</option>
                    </select>
                </div>
            </div>

            <!-- Nivel -->
            <div class="col-md-6">
                <label class="form-label">Nivel de Experiencia</label>
                <div class="input-group">
                    <span class="input-group-text bg-white border-end-0 rounded-start-3"><i class="bi bi-bar-chart-line text-primary"></i></span>
                    <select name="nivel" class="form-select border-start-0 ps-0" required>
                        <option value="" selected disabled>Seleccionar...</option>
                        <option value="principiante" {% if nivel == 'principiante' %}selected{% endif %}>Principiante (0-1 a√±os)</option>
                        <option value="intermedio" {% if nivel == 'intermedio' %}selected{% endif %}>Intermedio (1-3 a√±os)</option>
                        <option value="avanzado" {% if nivel == 'avanzado' %}selected{% endif %}>Avanzado (+3 a√±os)</option>
                    </select>
                </div>
            </div>

            <!-- D√≠as -->
            <div class="col-md-4">
                <label class="form-label">Frecuencia Semanal</label>
                <div class="input-group">
                    <span class="input-group-text bg-white border-end-0 rounded-start-3"><i class="bi bi-calendar-check text-primary"></i></span>
                    <input type="number" name="dias" class="form-control border-start-0 ps-0" min="1" max="6" value="{{ dias if dias else '' }}" placeholder="1-6 d√≠as" required>
                </div>
            </div>

            <!-- Lesi√≥n -->
            <div class="col-md-4">
                <label class="form-label">Limitaciones / Lesiones</label>
                <div class="input-group">
                    <span class="input-group-text bg-white border-end-0 rounded-start-3"><i class="bi bi-bandaid text-danger"></i></span>
                    <select name="lesion" class="form-select border-start-0 ps-0" required>
                        <option value="ninguna" {% if not lesion or lesion == 'ninguna' %}selected{% endif %}>Ninguna</option>
                        <option value="extremidad_superior" {% if lesion == 'extremidad_superior' %}selected{% endif %}>Extremidad Superior (Brazos/Hombros)</option>
                        <option value="extremidad_inferior" {% if lesion == 'extremidad_inferior' %}selected{% endif %}>Extremidad Inferior (Piernas/Rodillas)</option>
                        <option value="espalda_lumbar" {% if lesion == 'espalda_lumbar' %}selected{% endif %}>Espalda Baja / Lumbar</option>
                        <option value="espalda_cervical" {% if lesion == 'espalda_cervical' %}selected{% endif %}>Espalda Alta / Cervical</option>
                        <option value="core" {% if lesion == 'core' %}selected{% endif %}>Zona Abdominal / Core</option>
                    </select>
                </div>
            </div>

            <!-- Equipamiento -->
            <div class="col-md-4">
                <label class="form-label">Equipamiento Disponible</label>
                <div class="input-group">
                    <span class="input-group-text bg-white border-end-0 rounded-start-3"><i class="bi bi-box-seam text-primary"></i></span>
                    <select name="equipamiento" class="form-select border-start-0 ps-0" required>
                        <option value="" selected disabled>Seleccionar...</option>
                        <option value="peso_corporal" {% if equip == 'peso_corporal' %}selected{% endif %}>Solo Peso Corporal</option>
                        <option value="mancuernas" {% if equip == 'mancuernas' %}selected{% endif %}>Mancuernas en Casa</option>
                        <option value="gym_completo" {% if equip == 'gym_completo' %}selected{% endif %}>Gimnasio Completo</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="mt-4">
            <button type="submit" class="btn btn-primary-custom">
                <i class="bi bi-cpu-fill me-2"></i> Generar Rutina Inteligente
            </button>
        </div>
    </form>


    {% if rutina %}
    
    <!-- Secci√≥n de Resultados -->
    <div class="animate-up" style="animation-delay: 0.2s;">
        <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
            <h3 class="fw-bold mb-0">Tu Plan Semanal Personalizado</h3>
            <div class="d-flex gap-2 flex-wrap">
                <!-- Bot√≥n timer de descanso -->
                <button type="button" class="btn btn-sm btn-outline-custom" onclick="iniciarTimer()">
                    <i class="bi bi-stopwatch me-1"></i> Timer
                </button>
                
                <!-- Bot√≥n de descarga TXT -->
                <form method="POST" action="/download" style="display: inline;">
                    <input type="hidden" name="objetivo" value="{{ objetivo }}">
                    <input type="hidden" name="nivel" value="{{ nivel }}">
                    <input type="hidden" name="dias" value="{{ dias }}">
                    <input type="hidden" name="lesion" value="{{ lesion }}">
                    <input type="hidden" name="equipamiento" value="{{ equip }}">
                    <button type="submit" class="btn btn-outline-custom btn-sm">
                        <i class="bi bi-download me-1"></i> TXT
                    </button>
                </form>

                <!-- Bot√≥n de descarga JSON -->
                <form method="POST" action="/download_json" style="display: inline;">
                    <input type="hidden" name="objetivo" value="{{ objetivo }}">
                    <input type="hidden" name="nivel" value="{{ nivel }}">
                    <input type="hidden" name="dias" value="{{ dias }}">
                    <input type="hidden" name="lesion" value="{{ lesion }}">
                    <input type="hidden" name="equipamiento" value="{{ equip }}">
                    <button type="submit" class="btn btn-outline-custom btn-sm">
                        <i class="bi bi-filetype-json me-1"></i> JSON
                    </button>
                </form>

                <!-- Bot√≥n de descarga CALENDARIO -->
                <form method="POST" action="/download_calendar" style="display: inline;">
                    <input type="hidden" name="objetivo" value="{{ objetivo }}">
                    <input type="hidden" name="nivel" value="{{ nivel }}">
                    <input type="hidden" name="dias" value="{{ dias }}">
                    <input type="hidden" name="lesion" value="{{ lesion }}">
                    <input type="hidden" name="equipamiento" value="{{ equip }}">
                    <button type="submit" class="btn btn-outline-custom btn-sm">
                        <i class="bi bi-calendar-plus me-1"></i> Calendario
                    </button>
                </form>
            </div>
        </div>

        <!-- Resumen de par√°metros y estad√≠sticas -->
        {% if objetivo and nivel and dias %}
            <div class="summary-card">
                <div class="d-flex align-items-center mb-2">
                    <i class="bi bi-info-circle-fill text-primary me-2"></i>
                    <h5 class="mb-0 fw-bold">Configuraci√≥n y Estad√≠sticas</h5>
                </div>
                <div class="mb-3">
                    <span class="param-tag"><i class="bi bi-crosshair me-1"></i>{{ objetivo|replace('_', ' ')|capitalize }}</span>
                    <span class="param-tag"><i class="bi bi-ladder me-1"></i>{{ nivel|capitalize }}</span>
                    <span class="param-tag"><i class="bi bi-calendar3 me-1"></i>{{ dias }} d√≠as/sem</span>
                    <span class="param-tag"><i class="bi bi-tools me-1"></i>{{ equip|replace('_', ' ')|capitalize }}</span>
                    {% if lesion != 'ninguna' %}
                    <span class="param-tag"><i class="bi bi-bandaid me-1"></i>Lesi√≥n: {{ lesion|capitalize }}</span>
                    {% endif %}
                </div>

                {% if stats %}
                <div class="stats-grid">
                    <div class="stat-box">
                        <div class="stat-value">{{ stats.total_ejercicios }}</div>
                        <div class="stat-label">Ejercicios Totales</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value">{{ stats.promedio_ejercicios_por_dia }}</div>
                        <div class="stat-label">Promedio por D√≠a</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value">{{ stats.grupo_mas_trabajado|capitalize }}</div>
                        <div class="stat-label">Grupo Principal</div>
                    </div>
                </div>
                {% endif %}

                {% if training_params %}
                    <p class="mb-0 text-muted small border-top pt-2 mt-3">
                        <i class="bi bi-lightbulb-fill text-warning me-1"></i>
                        <strong>Recomendaci√≥n t√©cnica:</strong> Realizar 
                        <span class="text-dark fw-bold">{{ training_params.series }} series</span> de 
                        <span class="text-dark fw-bold">{{ training_params.reps }} repeticiones</span> por ejercicio.
                    </p>
                {% endif %}
            </div>
        {% endif %}

        <!-- Recomendaciones de Progresi√≥n -->
        {% if recomendaciones %}
        <div class="glass-card mb-4">
            <h5 class="fw-bold mb-3"><i class="bi bi-graph-up-arrow text-success me-2"></i>Recomendaciones de Progresi√≥n</h5>
            {% for rec in recomendaciones %}
            <div class="recommendation-item">
                <i class="bi bi-check-circle-fill"></i>
                <span>{{ rec }}</span>
            </div>
            {% endfor %}
        </div>
        {% endif %}

        <!-- Tarjetas de Rutina -->
        <div class="row">
        {% for dia in rutina %}
            <div class="col-md-6 col-lg-12">
                <div class="rutina-dia" id="dia-{{ dia[0] }}" data-dia="{{ dia[0] }}">
                    <div class="dia-header">
                        <span class="dia-badge">D√çA {{ dia[0] }}</span>
                        <span class="text-muted small ms-auto">
                            {% if dia|length > 2 %}
                            {{ dia[2] }} series √ó {{ dia[3] }} reps
                            {% else %}
                            Sesi√≥n completa
                            {% endif %}
                        </span>
                        <button class="btn btn-sm btn-outline-primary ms-2" 
                            onclick="optimizarDia({{ dia[0] }})"
                            title="Optimizar secuencia de ejercicios">
                            <i class="bi bi-lightning-charge"></i> Optimizar
                        </button>
                    </div>
                    <ul class="exercise-list">
                        {% for grupo, ejercicio in dia[1] %}
                            <li class="exercise-item" data-grupo="{{ grupo }}" data-ejercicio="{{ ejercicio }}">
                                <i class="bi bi-check-circle-fill exercise-icon"></i>
                                <div class="flex-grow-1">
                                    <strong class="text-uppercase text-secondary" style="font-size: 0.75rem; letter-spacing: 0.5px;">{{ grupo }}</strong>
                                    <div class="fw-bold text-dark">{{ ejercicio|replace('_', ' ')|capitalize }}</div>
                                </div>
                                <button class="exercise-info-btn" onclick="mostrarInfoEjercicio('{{ ejercicio }}')">
                                    <i class="bi bi-info-circle"></i>
                                </button>
                            </li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        {% endfor %}
        </div>
    </div>
    {% endif %}

</div>

<!-- Timer de Descanso -->
<div class="rest-timer" id="restTimer">
    <h6 class="text-center mb-0">Descanso</h6>
    <div class="timer-display" id="timerDisplay">01:30</div>
    <div class="timer-controls">
        <button class="btn btn-sm btn-success flex-grow-1" onclick="pausarTimer()">
            <i class="bi bi-pause-fill"></i>
        </button>
        <button class="btn btn-sm btn-danger flex-grow-1" onclick="cerrarTimer()">
            <i class="bi bi-x-lg"></i>
        </button>
    </div>
</div>

<!-- Modal Info Ejercicio -->
<div class="modal fade" id="exerciseModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exerciseModalTitle">Informaci√≥n del Ejercicio</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p id="exerciseNotes" class="mb-0"></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Calculadora 1RM -->
<div class="modal fade" id="calculadora1RMModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-calculator me-2"></i>Calculadora de 1RM</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p class="text-muted small mb-3">Calcula tu m√°ximo de una repetici√≥n (1RM) basado en el peso y repeticiones realizadas.</p>
                
                <div class="mb-3">
                    <label class="form-label">Peso levantado (kg)</label>
                    <input type="number" id="peso1rm" class="form-control" placeholder="Ej: 100" step="0.5" min="1">
                </div>
                
                <div class="mb-3">
                    <label class="form-label">Repeticiones realizadas</label>
                    <input type="number" id="reps1rm" class="form-control" placeholder="Ej: 8" min="1" max="20">
                </div>
                
                <div class="mb-3">
                    <label class="form-label">F√≥rmula</label>
                    <select id="formula1rm" class="form-select">
                        <option value="epley">Epley (Recomendada)</option>
                        <option value="brzycki">Brzycki</option>
                        <option value="lander">Lander</option>
                        <option value="lombardi">Lombardi</option>
                        <option value="mayhew">Mayhew</option>
                        <option value="oconner">O'Conner</option>
                        <option value="wathan">Wathan</option>
                    </select>
                </div>
                
                <button onclick="calcular1RM()" class="btn btn-primary-custom mb-3">
                    <i class="bi bi-calculator me-2"></i>Calcular
                </button>
                
                <div id="resultado1rm" style="display: none;">
                    <div class="alert alert-success">
                        <h6 class="mb-2">Tu 1RM estimado: <strong id="valor1rm"></strong> kg</h6>
                    </div>
                    
                    <h6 class="mb-2">Porcentajes de entrenamiento:</h6>
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>%</th>
                                    <th>Peso</th>
                                    <th>Uso recomendado</th>
                                </tr>
                            </thead>
                            <tbody id="tabla1rm">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Comparador de Rutinas -->
<div class="modal fade" id="comparadorModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-arrow-left-right me-2"></i>Comparar Rutinas</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p class="text-muted small mb-3">Compara dos rutinas de tu historial para ver las diferencias.</p>
                
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label class="form-label">Rutina 1</label>
                        <select id="rutina1Compare" class="form-select">
                            {% if session.get('historial') %}
                                {% for i in range(session.get('historial')|length) %}
                                <option value="{{ i }}">
                                    {{ session.get('historial')[i].fecha[:10] }} - {{ session.get('historial')[i].objetivo|replace('_',' ')|title }}
                                </option>
                                {% endfor %}
                            {% endif %}
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Rutina 2</label>
                        <select id="rutina2Compare" class="form-select">
                            {% if session.get('historial') %}
                                {% for i in range(session.get('historial')|length) %}
                                <option value="{{ i }}" {% if i == 1 %}selected{% endif %}>
                                    {{ session.get('historial')[i].fecha[:10] }} - {{ session.get('historial')[i].objetivo|replace('_',' ')|title }}
                                </option>
                                {% endfor %}
                            {% endif %}
                        </select>
                    </div>
                </div>
                
                <button onclick="compararRutinas()" class="btn btn-primary-custom mb-3">
                    <i class="bi bi-arrow-left-right me-2"></i>Comparar
                </button>
                
                <div id="resultadoComparacion" style="display: none;">
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Optimizador NP -->
<div class="modal fade" id="optimizadorModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-lightning-charge me-2"></i>Optimizaci√≥n de Secuencia (Algoritmo NP)
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <h6 class="mb-2"><i class="bi bi-info-circle me-2"></i>¬øQu√© hace este optimizador?</h6>
                    <p class="mb-2 small">
                        Encuentra el <strong>mejor orden</strong> para realizar tus ejercicios, minimizando:
                    </p>
                    <ul class="small mb-2">
                        <li>‚è±Ô∏è Tiempo perdido cambiando de equipamiento</li>
                        <li>üí™ Fatiga acumulada por trabajar el mismo m√∫sculo seguido</li>
                        <li>üîß Ajustes innecesarios de pesos y m√°quinas</li>
                    </ul>
                    <p class="mb-0 small">
                        <strong>Problema NP-Completo:</strong> Similar a optimizar rutas de entrega, requiere algoritmos especializados para encontrar la mejor soluci√≥n.
                    </p>
                </div>
                
                <div class="mb-3">
                    <label for="metodoOptimizacion" class="form-label">Algoritmo:</label>
                    <select class="form-select" id="metodoOptimizacion">
                        <option value="greedy">Greedy Heur√≠stica (O(N¬≤) - R√°pido)</option>
                        <option value="exacto">Fuerza Bruta (O(N!) - Lento, N‚â§10)</option>
                    </select>
                    <p class="small text-muted mt-2">Para N ‚â§ 10 ejercicios puedes usar el algoritmo exacto.</p>
                </div>
                
                <button onclick="ejecutarOptimizacion()" class="btn btn-primary-custom mb-3">
                    <i class="bi bi-lightning-charge me-2"></i>Ejecutar Optimizaci√≥n
                </button>
                
                <div id="loadingOptimizacion" style="display: none;" class="text-center my-3">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Optimizando...</span>
                    </div>
                    <p class="mt-2">Calculando secuencia √≥ptima...</p>
                </div>
                
                <div id="resultadoOptimizacion" style="display: none;">
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Bot√≥n Toggle Modo Oscuro -->
<button class="dark-mode-toggle" onclick="toggleDarkMode()" title="Cambiar tema">
    <i class="bi bi-moon-fill" id="darkModeIcon"></i>
</button>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // Timer de descanso
    let timerInterval;
    let timerSeconds = 90;
    let timerPaused = false;

    function iniciarTimer() {
        const timer = document.getElementById('restTimer');
        timer.classList.add('active');
        timerSeconds = 90;
        timerPaused = false;
        actualizarDisplay();
        
        if (timerInterval) clearInterval(timerInterval);
        
        timerInterval = setInterval(() => {
            if (!timerPaused && timerSeconds > 0) {
                timerSeconds--;
                actualizarDisplay();
                
                if (timerSeconds === 0) {
                    // Notificaci√≥n de fin
                    if ('Notification' in window && Notification.permission === 'granted') {
                        new Notification('GymBot', { body: '¬°Descanso terminado!' });
                    }
                    clearInterval(timerInterval);
                }
            }
        }, 1000);
    }

    function actualizarDisplay() {
        const mins = Math.floor(timerSeconds / 60);
        const secs = timerSeconds % 60;
        document.getElementById('timerDisplay').textContent = 
            `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
    }

    function pausarTimer() {
        timerPaused = !timerPaused;
    }

    function cerrarTimer() {
        const timer = document.getElementById('restTimer');
        timer.classList.remove('active');
        if (timerInterval) clearInterval(timerInterval);
    }

    // Info de ejercicio
    async function mostrarInfoEjercicio(nombre) {
        try {
            const response = await fetch(`/api/ejercicio/${nombre}`);
            const data = await response.json();
            
            document.getElementById('exerciseModalTitle').textContent = data.nombre;
            document.getElementById('exerciseNotes').textContent = data.notas_tecnica;
            
            const modal = new bootstrap.Modal(document.getElementById('exerciseModal'));
            modal.show();
        } catch (error) {
            console.error('Error cargando info del ejercicio:', error);
        }
    }

    // Pedir permiso para notificaciones
    if ('Notification' in window && Notification.permission === 'default') {
        Notification.requestPermission();
    }
</script>

<script>
// ===== MODO OSCURO =====
function toggleDarkMode() {
    document.body.classList.toggle('dark-mode');
    const isDark = document.body.classList.contains('dark-mode');
    
    // Cambiar icono
    const icon = document.getElementById('darkModeIcon');
    icon.className = isDark ? 'bi bi-sun-fill' : 'bi bi-moon-fill';
    
    // Guardar preferencia
    localStorage.setItem('darkMode', isDark ? 'enabled' : 'disabled');
}

// Cargar preferencia al inicio
document.addEventListener('DOMContentLoaded', function() {
    const darkMode = localStorage.getItem('darkMode');
    if (darkMode === 'enabled') {
        document.body.classList.add('dark-mode');
        document.getElementById('darkModeIcon').className = 'bi bi-sun-fill';
    }
});

// ===== CALCULADORA 1RM =====
function abrirCalculadora1RM() {
    const modal = new bootstrap.Modal(document.getElementById('calculadora1RMModal'));
    modal.show();
}

async function calcular1RM() {
    const peso = parseFloat(document.getElementById('peso1rm').value);
    const reps = parseInt(document.getElementById('reps1rm').value);
    const formula = document.getElementById('formula1rm').value;
    
    if (!peso || !reps || peso <= 0 || reps <= 0 || reps > 20) {
        alert('Por favor ingresa valores v√°lidos (peso > 0, repeticiones entre 1-20)');
        return;
    }
    
    try {
        const response = await fetch('/api/calcular_1rm', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ peso, reps, formula })
        });
        
        const data = await response.json();
        
        if (data.error) {
            alert('Error: ' + data.error);
            return;
        }
        
        // Mostrar resultado
        document.getElementById('valor1rm').textContent = data['1rm'];
        
        // Tabla de porcentajes
        const usos = {
            '95': 'M√°xima fuerza (1-3 reps)',
            '90': 'Fuerza pura (2-4 reps)',
            '85': 'Fuerza-Hipertrofia (4-6 reps)',
            '80': 'Hipertrofia (6-8 reps)',
            '75': 'Hipertrofia (8-10 reps)',
            '70': 'Hipertrofia-Resistencia (10-12 reps)',
            '65': 'Resistencia (12-15 reps)',
            '60': 'Resistencia muscular (15+ reps)'
        };
        
        let tablaHTML = '';
        for (const [porcentaje, peso_calc] of Object.entries(data)) {
            if (porcentaje !== '1rm') {
                tablaHTML += `
                    <tr>
                        <td><strong>${porcentaje}%</strong></td>
                        <td>${peso_calc} kg</td>
                        <td class="text-muted small">${usos[porcentaje]}</td>
                    </tr>
                `;
            }
        }
        
        document.getElementById('tabla1rm').innerHTML = tablaHTML;
        document.getElementById('resultado1rm').style.display = 'block';
        
    } catch (error) {
        console.error('Error:', error);
        alert('Error al calcular 1RM');
    }
}

// ===== COMPARADOR DE RUTINAS =====
function abrirComparador() {
    const modal = new bootstrap.Modal(document.getElementById('comparadorModal'));
    modal.show();
}

async function compararRutinas() {
    const index1 = parseInt(document.getElementById('rutina1Compare').value);
    const index2 = parseInt(document.getElementById('rutina2Compare').value);
    
    if (index1 === index2) {
        alert('Por favor selecciona dos rutinas diferentes');
        return;
    }
    
    try {
        const response = await fetch('/api/comparar', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ index1, index2 })
        });
        
        const data = await response.json();
        
        if (data.error) {
            alert('Error: ' + data.error);
            return;
        }
        
        // Mostrar resultados
        let html = '<h6 class="mb-3">Comparaci√≥n de Volumen por Grupo Muscular:</h6>';
        html += '<div class="table-responsive"><table class="table table-sm">';
        html += '<thead><tr><th>Grupo</th><th>Rutina 1</th><th>Rutina 2</th><th>Diferencia</th></tr></thead>';
        html += '<tbody>';
        
        for (const [grupo, vol1] of Object.entries(data.volumen_rutina1)) {
            const vol2 = data.volumen_rutina2[grupo];
            const diff = data.diferencias_volumen[grupo];
            const diffClass = diff > 0 ? 'text-success' : (diff < 0 ? 'text-danger' : 'text-muted');
            const diffIcon = diff > 0 ? '‚Üë' : (diff < 0 ? '‚Üì' : '=');
            
            html += `
                <tr>
                    <td><strong>${grupo.charAt(0).toUpperCase() + grupo.slice(1)}</strong></td>
                    <td>${vol1} ejercicios</td>
                    <td>${vol2} ejercicios</td>
                    <td class="${diffClass}">${diffIcon} ${Math.abs(diff)}</td>
                </tr>
            `;
        }
        
        html += '</tbody></table></div>';
        
        // Ejercicios √∫nicos
        html += '<div class="row mt-3">';
        html += '<div class="col-md-6">';
        html += '<h6>Solo en Rutina 1:</h6>';
        if (data.ejercicios_solo_rutina1.length > 0) {
            html += '<ul class="small">';
            data.ejercicios_solo_rutina1.forEach(ej => {
                html += `<li>${ej.replace(/_/g, ' ')}</li>`;
            });
            html += '</ul>';
        } else {
            html += '<p class="text-muted small">Ninguno</p>';
        }
        html += '</div>';
        
        html += '<div class="col-md-6">';
        html += '<h6>Solo en Rutina 2:</h6>';
        if (data.ejercicios_solo_rutina2.length > 0) {
            html += '<ul class="small">';
            data.ejercicios_solo_rutina2.forEach(ej => {
                html += `<li>${ej.replace(/_/g, ' ')}</li>`;
            });
            html += '</ul>';
        } else {
            html += '<p class="text-muted small">Ninguno</p>';
        }
        html += '</div>';
        html += '</div>';
        
        html += `<div class="alert alert-info mt-3">
            <strong>Ejercicios comunes:</strong> ${data.ejercicios_comunes.length} de ${data.total_ejercicios_r1} y ${data.total_ejercicios_r2}
        </div>`;
        
        document.getElementById('resultadoComparacion').innerHTML = html;
        document.getElementById('resultadoComparacion').style.display = 'block';
        
    } catch (error) {
        console.error('Error:', error);
        alert('Error al comparar rutinas');
    }
}

// ===== OPTIMIZADOR NP =====
let diaActualOptimizar = 1;
let paramsActualesOptimizar = {};

function optimizarDia(dia) {
    diaActualOptimizar = dia;
    
    // Extraer ejercicios del d√≠a desde el DOM
    const diaElement = document.getElementById(`dia-${dia}`);
    const ejerciciosElements = diaElement.querySelectorAll('.exercise-item');
    const ejercicios = [];
    
    ejerciciosElements.forEach(item => {
        const grupo = item.getAttribute('data-grupo');
        const ejercicio = item.getAttribute('data-ejercicio');
        ejercicios.push([grupo, ejercicio]);
    });
    
    paramsActualesOptimizar = { ejercicios };
    
    const modal = new bootstrap.Modal(document.getElementById('optimizadorModal'));
    modal.show();
    
    // Reset
    document.getElementById('resultadoOptimizacion').style.display = 'none';
    document.getElementById('loadingOptimizacion').style.display = 'none';
}

async function ejecutarOptimizacion() {
    const metodo = document.getElementById('metodoOptimizacion').value;
    const loadingDiv = document.getElementById('loadingOptimizacion');
    const resultadoDiv = document.getElementById('resultadoOptimizacion');
    
    // Mostrar loading
    loadingDiv.style.display = 'block';
    resultadoDiv.style.display = 'none';
    
    try {
        const response = await fetch('/api/optimizar_secuencia', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                dia: diaActualOptimizar,
                metodo: metodo,
                ...paramsActualesOptimizar
            })
        });
        
        const data = await response.json();
        
        console.log('üîç Datos recibidos del backend:', data);
        console.log('üîç costo_original:', data.costo_original);
        console.log('üîç ahorro:', data.ahorro);
        
        loadingDiv.style.display = 'none';
        
        if (data.error || !data.success) {
            alert('Error: ' + (data.error || 'No se pudo optimizar la secuencia'));
            return;
        }
        
        // Mostrar resultados
        let html = '<div class="alert alert-success">';
        html += '<h6 class="mb-2"><i class="bi bi-check-circle me-2"></i>Optimizaci√≥n Completada</h6>';
        html += `<p class="mb-1"><strong>M√©todo:</strong> ${data.metodo}</p>`;
        html += `<p class="mb-1"><strong>Costo original:</strong> ${data.costo_original} segundos</p>`;
        html += `<p class="mb-1"><strong>Costo optimizado:</strong> ${data.costo} segundos</p>`;
        
        // Mostrar ahorro o mensaje si no hay mejora
        if (data.ahorro > 0) {
            html += `<p class="mb-0"><strong>Ahorro:</strong> ${data.ahorro.toFixed(1)} segundos (${((data.ahorro / data.costo_original) * 100).toFixed(1)}% mejor)</p>`;
        } else {
            html += `<p class="mb-0"><strong>Resultado:</strong> La secuencia original ya era √≥ptima (no se encontr√≥ mejora)</p>`;
        }
        html += '</div>';
        
        html += '<h6 class="mt-3 mb-2">Secuencia Optimizada:</h6>';
        html += '<ol class="list-group list-group-numbered">';
        
        data.secuencia_optimizada.forEach((ej, idx) => {
            html += `
                <li class="list-group-item d-flex justify-content-between align-items-start">
                    <div class="ms-2 me-auto">
                        <div class="fw-bold">${ej.nombre_formateado}</div>
                        <small class="text-muted">${ej.grupo.toUpperCase()}</small>
                    </div>
                    <span class="badge bg-primary rounded-pill">${idx + 1}</span>
                </li>
            `;
        });
        
        html += '</ol>';
        
        // Explicaci√≥n educativa detallada
        html += '<div class="alert alert-info mt-3">';
        html += '<h6 class="mb-2"><i class="bi bi-lightbulb-fill me-2"></i>¬øPor qu√© es mejor esta secuencia?</h6>';
        html += '<p class="mb-2 small">El algoritmo optimiz√≥ <strong>3 factores clave</strong>:</p>';
        html += '<ul class="small mb-2">';
        html += '<li><strong>‚è±Ô∏è Tiempo de transici√≥n:</strong> Minimiza el tiempo perdido cambiando de equipamiento (barras ‚Üí mancuernas ‚Üí m√°quinas)</li>';
        html += '<li><strong>üí™ Fatiga muscular:</strong> Evita trabajar el mismo grupo muscular consecutivamente, permitiendo mejor recuperaci√≥n</li>';
        html += '<li><strong>üîß Setup de equipamiento:</strong> Reduce ajustes innecesarios entre ejercicios</li>';
        html += '</ul>';
        
        if (data.ahorro > 0) {
            html += `<p class="mb-0 small"><strong>Resultado:</strong> Ahorras <strong>${data.ahorro.toFixed(1)} segundos</strong> de tiempo muerto (${((data.ahorro / data.costo_original) * 100).toFixed(1)}% m√°s eficiente), permiti√©ndote entrenar mejor o agregar m√°s volumen.</p>`;
        } else {
            html += `<p class="mb-0 small"><strong>Resultado:</strong> Tu secuencia original ya estaba bien optimizada. El algoritmo confirm√≥ que es una de las mejores opciones posibles.</p>`;
        }
        html += '</div>';
        
        html += '<div class="alert alert-secondary mt-2">';
        html += '<small><i class="bi bi-cpu me-1"></i>';
        html += '<strong>Dato t√©cnico:</strong> Este es un problema NP-Completo (Optimal Exercise Sequencing), similar a optimizar rutas de entrega. ';
        html += `El algoritmo <em>${data.metodo}</em> encuentra una soluci√≥n ${data.metodo === 'exacto' ? '√≥ptima garantizada' : 'muy buena en tiempo razonable'}.`;
        html += '</small></div>';
        
        resultadoDiv.innerHTML = html;
        resultadoDiv.style.display = 'block';
        
    } catch (error) {
        loadingDiv.style.display = 'none';
        console.error('Error:', error);
        alert('Error al optimizar secuencia');
    }
}

</script>

</body>
</html>

